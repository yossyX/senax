# 遅延一括更新

## insert_delayed
ログやツイートを想定しており、同時にリクエストを受け付けた他の保存データとまとめてバルクインサートを行う。  
DBとの接続が切れている場合はディスクに保存して、接続が復活するとDBに保存される。  
リレーションのデータも同時に保存可能。

## save_delayed
アクセスカウンタを想定しており、同一のページへのアクセスが複数回行われる場合に、それらのアクセス数を加算してからDBへの加算クエリーが実行される。  
加算後のカウンタ値を取得してmax()メソッドでの更新に変換してサーバ間同期が行われるので、サーバ間のキャッシュ不整合が発生しない。 
それぞれの主キーごとに1クエリーが実行され、insert, update, delete に対応している。 
DBとの接続が切れている場合はディスクに保存せず、繰り返し再実行が行われる。その間サーバは終了できない。  
リレーションのデータは保存されない。

## update_delayed
save_delayedと同様にアクセスカウンタを想定し、update のみに対応している。同一の加算値である複数行の更新を主キーをIN句にまとめて1クエリーで実行するため効率が良い。 
加算後のカウンタ値を取得してmax()メソッドでの更新に変換してサーバ間同期が行われるので、サーバ間のキャッシュ不整合が発生しない。 
DBとの接続が切れている場合はディスクに保存せず、繰り返し再実行が行われる。その間サーバは終了できない。  
リレーションのデータは保存されない。

## upsert_delayed
「いいね！」のチェックを想定しており、同一の更新内容であれば複数行の upsert をまとめて実行する。  
「いいね！」の取り消しは delete ではなく、フラグの更新を想定している。
また、「いいね！」されていない初期状態は自動的にはキャッシュされないので、「いいね！」されていないフラグ状態のデータを insert_dummy_cache で登録することによりキャッシュが可能である。 
日毎のアクセスカウンタなど該当の日のデータが存在しない可能性のあるカウンタの加算にも使用できるが、カウンタ値のmax()メソッドへの変換に対応していないため、キャッシュの取得と更新のタイミングによって不整合が発生し、サーバごとに異なる値を返す可能性がある。 
キャッシュが適切に更新されるためには、主キーがオートインクリメントではなく外部キーの組み合わせなどで決定される必要がある。
DBとの接続が切れている場合はディスクに保存せず、繰り返し再実行が行われる。その間サーバは終了できない。  
リレーションのデータは保存されない。
